<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyDoc 2.0 - Custom Document Editor</title>
    <!-- Add CSP to allow jsPDF from cdnjs -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self';">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
            max-width: 100%;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            font-size: 1.5em;
        }

        .box {
            background-color: #d3d3d3; /* Default gray background */
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            transition: all 0.3s ease; /* Smooth transition for customizations */
        }

        .box-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .box-buttons button {
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
        }

        textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
            border: none;
            background: transparent;
            font-size: 1em;
            transition: all 0.3s ease; /* Smooth transition for size/font changes */
        }

        #preview-shape pre {
            margin: 0;
            white-space: pre-wrap;
            background-color: #e0e0e0; /* Lighter gray for preview */
            padding: 10px;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            margin: 5px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #status {
            color: #333;
            word-wrap: break-word;
        }

        .customize-panel {
            margin: 10px 0;
            padding: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            display: none;
        }

        .customize-panel.active {
            display: block;
        }

        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.2em;
            }
            .box {
                padding: 5px;
                margin: 5px 0;
            }
            .box-buttons {
                top: 5px;
                right: 5px;
                flex-direction: column;
                gap: 2px;
            }
            .box-buttons button {
                padding: 3px 6px;
                font-size: 0.7em;
            }
            textarea {
                min-height: 60px;
                font-size: 0.9em;
            }
            button {
                padding: 8px;
                font-size: 0.9em;
            }
            select, input[type="text"], input[type="color"], input[type="number"] {
                width: 100%;
                padding: 5px;
                font-size: 0.9em;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <h1>EasyDoc 2.0 - Custom Document Editor</h1>

    <!-- 1. Document Switcher -->
    <label for="document-select">Select Document:</label>
    <select id="document-select" onchange="switchDocument()">
        <option value="portfolio">Portfolio</option>
        <option value="curriculum">Curriculum</option>
        <option value="new">New Document...</option>
    </select>

    <!-- 2. Text Boxes -->
    <div id="boxes">
        <div class="box" id="box-0">
            <label for="textarea-0">Text Box 1:</label>
            <textarea id="textarea-0">Start typing here...</textarea>
            <div class="box-buttons">
                <button onclick="customizeBox(0)">Customize</button>
                <button onclick="moveBox(0, 'up')" id="box-0-up">Move Up</button>
                <button onclick="moveBox(0, 'down')" id="box-0-down">Move Down</button>
            </div>
        </div>
    </div>

    <!-- 3. Add Box -->
    <button onclick="addBox()">Add Box</button>

    <!-- 4. Customize Panel (Hidden by default) -->
    <div id="customize-panel" class="customize-panel">
        <label for="box-color">Background Color:</label>
        <input type="color" id="box-color" value="#d3d3d3">
        <label for="font-size">Font Size (px):</label>
        <input type="number" id="font-size" value="16" min="10" max="30">
        <label for="font-family">Font Family:</label>
        <select id="font-family">
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Courier New">Courier New</option>
        </select>
        <button onclick="applyCustomization()">Apply</button>
    </div>

    <!-- 5. Refresh Preview -->
    <button onclick="updatePreview()">Refresh Preview</button>

    <!-- 6. Preview -->
    <div class="shape" id="preview-shape">
        <label for="preview">Preview:</label>
        <pre id="preview">Preview will appear here...</pre>
    </div>

    <!-- 7. Save Content -->
    <button onclick="saveContent()">Save Content</button>

    <!-- 8. Load File -->
    <button onclick="loadFile()">Load File into Content</button>
    <input type="file" id="fileInput" style="display:none;" accept=".txt" onchange="handleFileSelect(event)">

    <!-- 9. Generate PDF -->
    <button onclick="generatePDF()">Generate PDF</button>

    <!-- 10. Output File Name -->
    <label for="filename-input">Output Filename:</label>
    <input type="text" id="filename-input" value="output.pdf">

    <p id="status"></p>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let documents = {
            'portfolio': {
                boxes: [{ id: 0, content: 'Start typing here...', color: '#d3d3d3', fontSize: 16, fontFamily: 'Arial' }],
                order: [0]
            },
            'curriculum': {
                boxes: [{ id: 0, content: 'Start typing here...', color: '#d3d3d3', fontSize: 16, fontFamily: 'Arial' }],
                order: [0]
            }
        };
        let currentDocument = 'portfolio';
        let currentBoxId = 1; // For generating unique box IDs

        function switchDocument() {
            const select = document.getElementById('document-select');
            const value = select.value;
            if (value === 'new') {
                const newName = prompt('Enter a name for the new document:');
                if (newName && !documents[newName.toLowerCase()]) {
                    documents[newName.toLowerCase()] = {
                        boxes: [{ id: 0, content: 'Start typing here...', color: '#d3d3d3', fontSize: 16, fontFamily: 'Arial' }],
                        order: [0]
                    };
                    select.add(new Option(newName, newName.toLowerCase()));
                    select.value = newName.toLowerCase();
                } else {
                    select.value = currentDocument;
                    document.getElementById('status').textContent = 'Document name already exists or invalid!';
                    return;
                }
            }
            currentDocument = select.value;
            renderBoxes();
            updatePreview();
        }

        function renderBoxes() {
            const boxesDiv = document.getElementById('boxes');
            boxesDiv.innerHTML = '';
            const doc = documents[currentDocument];
            doc.order.forEach((boxId, index) => {
                const box = doc.boxes.find(b => b.id === boxId);
                const textarea = document.createElement('textarea');
                textarea.id = `textarea-${boxId}`;
                textarea.value = box.content;

                const boxDiv = document.createElement('div');
                boxDiv.className = 'box';
                boxDiv.id = `box-${boxId}`;
                boxDiv.style.backgroundColor = box.color;
                textarea.style.fontSize = `${box.fontSize}px`;
                textarea.style.fontFamily = box.fontFamily;
                boxDiv.innerHTML = `<label for="textarea-${boxId}">Text Box ${boxId + 1}:</label>${textarea.outerHTML}<div class="box-buttons"><button onclick="customizeBox(${boxId})">Customize</button><button onclick="moveBox(${boxId}, 'up')" id="box-${boxId}-up">Move Up</button><button onclick="moveBox(${boxId}, 'down')" id="box-${boxId}-down">Move Down</button></div>`;

                boxesDiv.appendChild(boxDiv);
            });

            // Update button states
            doc.order.forEach((boxId, index) => {
                document.getElementById(`box-${boxId}-up`).disabled = index === 0;
                document.getElementById(`box-${boxId}-down`).disabled = index === doc.order.length - 1;
            });
        }

        function moveBox(boxId, direction) {
            const doc = documents[currentDocument];
            const index = doc.order.indexOf(boxId);
            if (direction === 'up' && index > 0) {
                [doc.order[index], doc.order[index - 1]] = [doc.order[index - 1], doc.order[index]];
            } else if (direction === 'down' && index < doc.order.length - 1) {
                [doc.order[index], doc.order[index + 1]] = [doc.order[index + 1], doc.order[index]];
            }
            renderBoxes();
            updatePreview();
        }

        function addBox() {
            const doc = documents[currentDocument];
            const newBoxId = currentBoxId++;
            const newBox = {
                id: newBoxId,
                content: 'Start typing here...',
                color: doc.boxes[0].color,
                fontSize: doc.boxes[0].fontSize,
                fontFamily: doc.boxes[0].fontFamily
            };
            doc.boxes.push(newBox);
            doc.order.push(newBoxId);
            renderBoxes();
            updatePreview();
            document.getElementById('status').textContent = `Added new box: Text Box ${newBoxId + 1}`;
        }

        function customizeBox(boxId) {
            const doc = documents[currentDocument];
            const box = doc.boxes.find(b => b.id === boxId);
            document.getElementById('box-color').value = box.color;
            document.getElementById('font-size').value = box.fontSize;
            document.getElementById('font-family').value = box.fontFamily;
            document.getElementById('customize-panel').classList.add('active');
            document.getElementById('customize-panel').dataset.boxId = boxId;
        }

        function applyCustomization() {
            const boxId = parseInt(document.getElementById('customize-panel').dataset.boxId);
            const doc = documents[currentDocument];
            const box = doc.boxes.find(b => b.id === boxId);
            if (box) {
                box.color = document.getElementById('box-color').value;
                box.fontSize = parseInt(document.getElementById('font-size').value);
                box.fontFamily = document.getElementById('font-family').value;
                document.getElementById('customize-panel').classList.remove('active');
                renderBoxes();
                updatePreview();
            } else {
                document.getElementById('status').textContent = 'Error: Box not found!';
            }
        }

        function updatePreview() {
            const doc = documents[currentDocument];
            let preview = '';
            doc.order.forEach((boxId, index) => {
                const box = doc.boxes.find(b => b.id === boxId);
                const textarea = document.getElementById(`textarea-${boxId}`);
                if (textarea) {
                    box.content = textarea.value; // Update content from textarea
                }
                if (preview !== '') preview += '\n\n';
                preview += `${box.content}`;
            });
            document.getElementById('preview').textContent = preview;
        }

        function generatePDF() {
            const doc = documents[currentDocument];
            const filename = document.getElementById('filename-input').value || 'output.pdf';
            let pdfContent = '';
            doc.order.forEach((boxId, index) => {
                const box = doc.boxes.find(b => b.id === boxId);
                const textarea = document.getElementById(`textarea-${boxId}`);
                if (textarea) {
                    box.content = textarea.value; // Update content from textarea
                }
                if (pdfContent !== '') pdfContent += '\n\n';
                pdfContent += `${box.content}`;
            });

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            pdf.text(pdfContent, 10, 10);
            pdf.save(filename);
            document.getElementById('status').textContent = `PDF generated and downloaded as ${filename}`;
        }

        function saveContent() {
            const doc = documents[currentDocument];
            doc.order.forEach(boxId => {
                const box = doc.boxes.find(b => b.id === boxId);
                const textarea = document.getElementById(`textarea-${boxId}`);
                if (textarea) {
                    box.content = textarea.value; // Update content from textarea
                }
            });
            let fullContent = `===DOCUMENT:${currentDocument}===\n===BOXES===\n`;
            doc.boxes.forEach(box => {
                fullContent += `id:${box.id},content:${box.content.replace(/,/g, '\\,')},color:${box.color},fontSize:${box.fontSize},fontFamily:${box.fontFamily}\n`;
            });
            fullContent += `===ORDER===\n${doc.order.join(',')}`;
            const blob = new Blob([fullContent], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${currentDocument}_save.txt`;
            link.click();
            document.getElementById('status').textContent = `Content saved as ${currentDocument}_save.txt`;
        }

        function loadFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    let newDocument = '';
                    let newBoxes = [];
                    let newOrder = [];

                    // Parse document name
                    if (content.includes('===DOCUMENT:')) {
                        const docStart = content.indexOf('===DOCUMENT:') + '===DOCUMENT:'.length;
                        const docEnd = content.indexOf('===', docStart);
                        if (docEnd !== -1) {
                            newDocument = content.substring(docStart, docEnd).trim().toLowerCase();
                        }
                    }

                    // Parse boxes
                    let boxesStart = content.indexOf('===BOXES===') + '===BOXES==='.length;
                    let orderStart = content.indexOf('===ORDER===');
                    if (boxesStart !== -1 && orderStart !== -1) {
                        const boxesContent = content.substring(boxesStart, orderStart).trim().split('\n');
                        boxesContent.forEach(line => {
                            if (line) {
                                const parts = line.split(',content:');
                                const idPart = parts[0];
                                const rest = parts[1].split(',color:');
                                const contentPart = rest[0].replace(/\\,/g, ',');
                                const rest2 = rest[1].split(',fontSize:');
                                const colorPart = rest2[0];
                                const rest3 = rest2[1].split(',fontFamily:');
                                const fontSizePart = rest3[0];
                                const fontFamilyPart = rest3[1];

                                const id = parseInt(idPart.split(':')[1]);
                                const content = contentPart;
                                const color = colorPart;
                                const fontSize = parseInt(fontSizePart);
                                const fontFamily = fontFamilyPart;
                                newBoxes.push({ id, content, color, fontSize, fontFamily });
                                if (id >= currentBoxId) currentBoxId = id + 1;
                            }
                        });

                        // Parse order
                        const orderContent = content.substring(orderStart + '===ORDER==='.length).trim().split(',');
                        newOrder = orderContent.map(id => parseInt(id));
                    }

                    if (newDocument && newBoxes.length > 0 && newOrder.length > 0) {
                        documents[newDocument] = { boxes: newBoxes, order: newOrder };
                        if (!document.getElementById('document-select').querySelector(`option[value="${newDocument}"]`)) {
                            document.getElementById('document-select').add(new Option(newDocument, newDocument));
                        }
                        document.getElementById('document-select').value = newDocument;
                        currentDocument = newDocument;
                        renderBoxes();
                        updatePreview();
                        document.getElementById('status').textContent = `Loaded document: ${newDocument}`;
                    } else {
                        document.getElementById('status').textContent = 'Invalid file format!';
                    }
                };
                reader.readAsText(file);
            } else {
                document.getElementById('status').textContent = 'No file selected.';
            }
        }

        // Initial setup
        renderBoxes();
        updatePreview();
    </script>
</body>
</html>
